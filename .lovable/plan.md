
Цель: довести админку до состояния “полноценная CMS”:  
1) видимость блоков главной реально управляется из админки,  
2) редактирование текстов/картинок всех блоков главной,  
3) редактирование отдельных страниц (/about, /programs, /clubs, /gallery, /svedeniya),  
4) редактор навигации (navigation_items),  
5) админка новостей: список + создание/редактирование/удаление + картинка (загрузка или URL) + ручной импорт через существующую backend‑функцию импорта.

---

## 0) Что уже есть (на что опираемся)
- Таблица `site_content (id, section_name, is_visible, content jsonb)` + RLS: публичный SELECT, admin UPDATE/INSERT/DELETE.
- `useContent(id)` уже читает `site_content` через `maybeSingle()` — хорошо для fallback, если записи нет.
- На главной (`Index.tsx`) уже добавлена логика `is_visible` для блоков.
- Есть заготовка редактора Hero: `AdminSectionHero.tsx` (редактирует `site_content`).
- Есть медиа‑раздел `/admin/media` + универсальный `ImageUploader` (загрузка в хранилище, сохраняем только URL/путь, без файлов в БД).
- Новости на сайте уже существуют: `/news` (NewsIndex) и `/news/:slug` (NewsPost) и таблица `posts`.

---

## 1) Шаг 1 — “Видимость” блоков главной: сделать полностью рабочей (и удобной в админке)
### Проблема, которую нужно решить
Сейчас `Index.tsx` читает `is_visible`, но в админке управление “видимостью” для всех секций может быть неполным/ломаться из-за:
- отсутствия строк в `site_content` (редактор ожидает `.single()` и падает),
- роут `/admin/sections/:id` ведёт всегда в `AdminSectionHero` (даже для non‑hero), поэтому часть секций невозможно нормально редактировать.

### Что делаем
1.1. Сделать “безопасную” модель: если строки для секции нет — админ всё равно может её создать (upsert).  
- В редакторах использовать `maybeSingle()` на чтение.
- На сохранении делать `upsert({ id, section_name, is_visible, content })` вместо чистого `update` (или `insert`+`update` fallback).

1.2. Создать универсальный экран “Редактор секции” (роут `/admin/sections/:id`), который:
- открывает нужный UI в зависимости от `id` (hero / features / about / programs / clubs / testimonials / news_home / gallery / contact / footer),
- везде показывает переключатель `is_visible` (с пояснением “скрывает только на главной”).

1.3. Исправить маршрутизацию:
- `/admin/sections/hero` и `/admin/sections/:id` больше не должны всегда показывать `AdminSectionHero`.
- Вынести Hero в специализированный редактор, а `:id` — в новый “SectionEditorRouter”.

### Результат шага 1
- Переключатель “видимость” начинает реально влиять на блоки главной (уже влияет) и из админки гарантированно управляется для всех секций (даже если строки в БД не было).

---

## 2) Шаг 2 — Админ‑редакторы контента главной (текст + картинки)
Задача: админка должна править “фото и текст на главной странице во всех блоках”.

### Подход
- Для каждой секции главной фиксируем структуру `site_content.content` (JSON).  
- В админке даём нормальные формы (Input/Textarea/Switch + ImageUploader + поле “внешний URL”).
- На публичной стороне компоненты секций начнут брать данные из `useContent('sectionId')` и подставлять вместо хардкода (при отсутствии данных — fallback на текущие значения).

### Секции, которые покрываем
- `hero` (уже есть, но доведём до общего стандарта upsert/maybeSingle).
- `features`
- `about`
- `programs`
- `clubs`
- `testimonials`
- `news_home` (например: заголовок блока, подзаголовок, “ссылка все новости”, лимит/логика)
- `gallery`
- `contact`
- `footer`

### Картинки
Для каждого “слота картинки” поддерживаем 2 режима:
- storage‑картинка (через ImageUploader) — сохраняем `{type:"storage", bucket, path, publicUrl, alt}`
- внешний URL — сохраняем `{type:"url", url, alt}`  
В UI делаем радиокнопку/селект “Источник: Загрузка / URL” и показываем нужные поля.

---

## 3) Шаг 3 — Редакторы отдельных страниц (/about /programs /clubs /gallery /svedeniya)
Задача: “редактирование всех отдельных страниц текст картинки”.

### Как храним
- Используем тот же `site_content`, но отдельные `id`, например:
  - `page_about`
  - `page_programs`
  - `page_clubs`
  - `page_gallery`
  - `page_svedeniya`

### Что меняем на публичных страницах
- `AboutPage.tsx`, `ProgramsPage.tsx`, `ClubsPage.tsx`, `GalleryPage.tsx`, `Svedeniya.tsx`
  - подключаем `useContent("page_...")`
  - отображаем тексты/картинки из `content`
  - при `null`/пусто — fallback на текущую вёрстку/контент (чтобы сайт не ломался)

### Формат текста
Вы выбрали “Обычный текст”. Значит:
- в админке — Textarea
- на сайте — выводим безопасно как текст (с `whitespace-pre-line`), без `dangerouslySetInnerHTML`.

---

## 4) Шаг 4 — Навигация: редактор `navigation_items` (порядок, вложенность, видимость)
### Текущее состояние
- Таблица `navigation_items` уже есть и публично читается, а править могут только админы (RLS уже настроен).

### Что делаем
4.1. Экран `/admin/navigation`:
- список пунктов меню (area: “top”, “school”, “svedeniya” и т.п.)
- редактирование: label, href, kind, parent_id, sort_order, is_visible
- кнопки “вверх/вниз” (меняет sort_order) + “сделать дочерним/убрать родителя”
- создание нового пункта и удаление

4.2. Подключаем публичную навигацию (`src/components/Navigation.tsx`) к данным из БД:
- `useQuery(["navigation_items"])` + сортировка на клиенте по `area/sort_order`
- рендерим меню и вложенность по `parent_id`
- если таблица пустая/ошибка — fallback на текущий hardcoded массив (чтобы не сломать сайт)

---

## 5) Шаг 5 — Новости: админ‑панель (CRUD) + картинка + ручной импорт
Вы попросили: “админка страницы новостей с созданием отдельной страницы для новости нужно добавление картинки” — публичная часть уже есть (`/news` и `/news/:slug`), теперь нужно управление из админки.

### 5.1. База данных и безопасность
Сейчас `posts` публично читается, но INSERT/UPDATE/DELETE запрещены для всех. Нужно добавить политики:
- Admins can insert posts
- Admins can update posts
- Admins can delete posts  
Условие: `has_role(auth.uid(), 'admin')`.

Это делаем миграцией (schema/policies), без раскрытия данных.

### 5.2. Админ UI
Создаём раздел `/admin/posts` (или расширяем текущий `/admin/news`, но лучше разделить: “Новости (управление)” и “Импорт/утилиты”):
- Список новостей:
  - поиск по заголовку/slug
  - фильтр по категории
  - кнопка “Создать новость”
- Редактор новости (create/edit):
  - title (обяз.)
  - slug (обяз.; автогенерация из title + ручное редактирование)
  - category (обяз.; можно селект + “другая”)
  - excerpt (необяз.)
  - content (обычный текст, textarea)
  - published_at (опционально; по умолчанию now)
  - image_url:
    - “Загрузка” в bucket `news` через ImageUploader (сохранение publicUrl)
    - “URL” внешний
- Удаление новости (с подтверждением)

### 5.3. Отображение картинки на сайте
Уже есть:
- в списке `/news` показывается `image_url ?? /placeholder.svg`
- в `/news/:slug` показывается `image_url ?? /placeholder.svg`  
Значит достаточно гарантировать, что админка записывает `image_url`.

### 5.4. Ручной импорт через существующую функцию импорта
У вас уже есть backend‑функция `news-import` (принимает массив постов, умеет dedup, умеет вычислять картинку).  
Добавляем UI в админке:
- поле вставки JSON (payload вида `{ posts: [...] }`)
- валидация JSON на клиенте (минимальная) + отправка `supabase.functions.invoke("news-import")`
- отчёт результатов: inserted/updated + ссылки “открыть” на `/news/:slug`

---

## 6) Изменения в админ‑навигации (sidebar)
Добавим пункты:
- “Секции” (уже есть)
- “Страницы”
- “Навигация”
- “Новости” (управление)
- “Импорт новостей” (или оставим как утилиты в текущем AdminNews)

---

## 7) Технические детали (для реализации)
- Новые/изменённые страницы админки будут использовать `react-query` + `supabase` клиент.
- Для `site_content` редакторов:
  - чтение: `maybeSingle()`
  - сохранение: `upsert()` (чтобы не зависеть от наличия строки)
- Для картинок:
  - никогда не хранить файлы в БД, только ссылки/пути
  - загрузка через существующий `ImageUploader`/`useImageUpload`
- Для текста:
  - хранить как string
  - выводить на сайте безопасно (без HTML), с `whitespace-pre-line`
- Для новостей:
  - добавить RLS политики на `posts` для админа (INSERT/UPDATE/DELETE)
  - редактор будет писать в `posts` напрямую (в рамках политики)

---

## 8) Порядок работ (рекомендуемая последовательность)
1) Починить роутинг и универсальный редактор секций + upsert/maybeSingle (закрывает “видимость” и делает базу для всего CMS).  
2) Подключить публичные блоки главной к `site_content.content` (с fallback) + формы для каждого блока.  
3) Добавить редакторы страниц `page_*` + подключить публичные страницы.  
4) Редактор `navigation_items` + переключение Navigation на данные из БД (fallback оставить).  
5) Новости: добавить RLS политики + построить CRUD‑админку + страницу ручного импорта.

---

## Критерии готовности (как проверяем)
- В админке выключаем `about` → на главной блок пропадает, но `/about` открывается.
- Меняем текст/картинку в hero/about/programs и видим изменения на сайте без правок кода.
- В админке создаём новость с картинкой (загрузка или URL) → в `/news` видна карточка с картинкой, а `/news/:slug` показывает изображение и текст.
- В админке меняем меню (порядок/видимость) → навигация на сайте обновляется.

