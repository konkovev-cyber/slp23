# Инструкция по деплою обновлений импорта новостей

## Что было изменено

### 1. База данных
- **Файл**: `supabase/migrations/20260131160000_add_post_media.sql`
- **Описание**: Добавлена таблица `post_media` для хранения множественных изображений

### 2. Edge Function
- **Файл**: `supabase/functions/fetch-metadata/index.ts`
- **Описание**: Полностью переписана функция с:
  - Правильной обработкой UTF-8 кодировки
  - Поддержкой множественных изображений
  - Улучшенным парсингом Telegram и VK
  - Поддержкой любых сайтов с Open Graph

### 3. Frontend
- **Файл**: `src/pages/AdminNews.tsx`
- **Описание**: Добавлено:
  - Поле `mediaList` для хранения массива изображений
  - Визуальная галерея импортированных изображений
  - Улучшенный UI импорта
  - Индикатор загрузки

## Как задеплоить (если используете Supabase)

### Вариант 1: Через Supabase Dashboard

#### Миграция базы данных:
1. Откройте Supabase Dashboard
2. Перейдите в **SQL Editor**
3. Создайте новый запрос
4. Скопируйте содержимое файла `supabase/migrations/20260131160000_add_post_media.sql`
5. Выполните запрос

#### Edge Function:
1. В Supabase Dashboard перейдите в **Edge Functions**
2. Найдите функцию `fetch-metadata`
3. Обновите код из файла `supabase/functions/fetch-metadata/index.ts`
4. Сохраните и задеплойте

### Вариант 2: Через Supabase CLI

```bash
# 1. Применить миграцию
supabase db push

# 2. Задеплоить Edge Function
supabase functions deploy fetch-metadata
```

### Вариант 3: Через Git (если настроен CI/CD)

```bash
git add .
git commit -m "feat: improved news import with UTF-8 encoding and multiple images support"
git push origin main
```

## Проверка работоспособности

### Тест 1: Импорт из Telegram
1. Откройте админ-панель → Новости → Добавить
2. Вставьте ссылку: `https://t.me/life_news_gk/45392`
3. Нажмите "Импорт"
4. Проверьте:
   - ✅ Текст отображается правильно (без кракозябр)
   - ✅ Все изображения импортированы
   - ✅ Галерея показывает превью

### Тест 2: Импорт из VK
1. Вставьте любую публичную ссылку VK
2. Проверьте корректность импорта

### Тест 3: Импорт с обычного сайта
1. Вставьте ссылку на новостную статью
2. Проверьте импорт метаданных

## Откат изменений (если что-то пошло не так)

### Откат миграции:
```sql
DROP TABLE IF EXISTS public.post_media CASCADE;
```

### Откат Edge Function:
Восстановите предыдущую версию из Git или используйте старый код

## Поддержка

Если возникли проблемы:
1. Проверьте консоль браузера на ошибки
2. Проверьте логи Edge Function в Supabase Dashboard
3. Убедитесь, что миграция применена успешно
