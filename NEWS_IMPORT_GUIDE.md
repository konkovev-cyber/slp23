# Модуль импорта новостей - Документация

## Обзор

Улучшенный модуль импорта новостей поддерживает:
- ✅ **Правильная кодировка UTF-8** - корректное отображение кириллицы
- ✅ **Множественные изображения** - импорт всех фото из поста
- ✅ **Разные источники** - Telegram, VK, и любые сайты с Open Graph
- ✅ **Визуальный превью** - галерея импортированных изображений
- ✅ **Автоматическое извлечение контента** - текст, заголовок, описание

## Поддерживаемые источники

### 1. Telegram
- **Формат URL**: `https://t.me/channel_name/post_id`
- **Пример**: `https://t.me/lichnost_PLUS/449`
- **Что импортируется**:
  - Заголовок поста
  - Полный текст сообщения
  - Все изображения из поста
  - Дата публикации

### 2. VK (ВКонтакте)
- **Формат URL**: `https://vk.com/wall-XXXXX_YYYYY`
- **Пример**: `https://vk.com/wall-12345_67890`
- **Что импортируется**:
  - Текст поста
  - Все прикрепленные фотографии
  - Метаданные

### 3. Другие сайты
- Любые сайты с Open Graph метаданными
- **Что импортируется**:
  - `og:title` - заголовок
  - `og:description` - описание
  - `og:image` - главное изображение
  - Все изображения со страницы

## Как использовать

### Шаг 1: Откройте форму создания новости
1. Перейдите в раздел **Новости** в админ-панели
2. Нажмите кнопку **"Добавить"**

### Шаг 2: Импортируйте контент
1. Вставьте ссылку на пост в поле **"Импорт из внешних источников"**
2. Нажмите кнопку **"Импорт"**
3. Подождите загрузки (обычно 2-5 секунд)

### Шаг 3: Проверьте импортированные данные
После успешного импорта автоматически заполнятся:
- **Заголовок** - из метаданных поста
- **Slug** - автоматически сгенерированный URL
- **Краткое описание** - из описания поста
- **Полный текст** - контент поста
- **Изображение (обложка)** - первое фото
- **Галерея изображений** - все остальные фото

### Шаг 4: Отредактируйте при необходимости
- Измените заголовок, текст или описание
- Удалите ненужные изображения из галереи
- Выберите категорию
- Установите дату публикации

### Шаг 5: Сохраните
Нажмите **"Сохранить"** для публикации новости

## Примеры использования

### Пример 1: Импорт из Telegram
```
URL: https://t.me/life_news_gk/45392
Результат:
- Заголовок: "Горячий Ключ LIFE"
- Текст: Полный текст поста
- Изображения: 3 фотографии
```

### Пример 2: Импорт из VK
```
URL: https://vk.com/wall-123456_789
Результат:
- Заголовок: Из метаданных VK
- Текст: Текст поста
- Изображения: Все прикрепленные фото
```

### Пример 3: Импорт с обычного сайта
```
URL: https://example.com/news/article
Результат:
- Заголовок: og:title
- Описание: og:description
- Изображение: og:image
```

## Технические детали

### Обработка кодировки
Система автоматически определяет кодировку:
1. **UTF-8** - для современных сайтов и соцсетей
2. **Windows-1251** - для старых русскоязычных сайтов
3. Декодирование HTML-сущностей (`&nbsp;`, `&quot;`, и т.д.)

### Множественные изображения
- Первое изображение → обложка новости (`image_url`)
- Остальные изображения → добавляются в текст новости
- Максимум 20 изображений за один импорт
- Поддержка форматов: PNG, JPEG, WebP, GIF

### База данных
Создана новая таблица `post_media` для хранения множественных изображений:
```sql
CREATE TABLE post_media (
  id UUID PRIMARY KEY,
  post_id UUID REFERENCES posts(id),
  media_url TEXT NOT NULL,
  media_type TEXT DEFAULT 'image',
  display_order INTEGER,
  alt_text TEXT
);
```

## Решение проблем

### Проблема: Неправильная кодировка
**Решение**: Обновленная функция `fetch-metadata` автоматически определяет кодировку. Если проблема сохраняется, проверьте исходный URL в браузере.

### Проблема: Изображения не загружаются
**Возможные причины**:
- Изображения защищены от hotlinking
- Требуется авторизация для просмотра
- Неверный формат URL

**Решение**: Загрузите изображения вручную через ImageUploader

### Проблема: Не импортируется текст
**Возможные причины**:
- Сайт использует JavaScript для загрузки контента
- Нестандартная структура HTML

**Решение**: Скопируйте текст вручную

## API функции fetch-metadata

### Запрос
```typescript
POST /fetch-metadata
Body: { url: string }
```

### Ответ
```typescript
{
  title: string;           // Заголовок
  description: string;     // Описание
  content: string;         // Полный текст
  image: string;          // Главное изображение
  mediaList: string[];    // Все изображения
  source: 'telegram' | 'vk' | 'web';
}
```

## Changelog

### v2.0 (31.01.2026)
- ✅ Исправлена проблема с кодировкой UTF-8
- ✅ Добавлена поддержка множественных изображений
- ✅ Расширена поддержка источников
- ✅ Добавлена визуальная галерея импортированных изображений
- ✅ Улучшена обработка ошибок
- ✅ Добавлена миграция для таблицы post_media

### v1.0 (24.01.2026)
- Базовый импорт из VK и Telegram
- Поддержка одного изображения
