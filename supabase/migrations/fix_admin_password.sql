-- ============================================================================
-- Миграция: Исправление пароля администратора
-- Версия: 1.0.0
-- Дата: 2026-02-10
-- Описание: Обновление пароля пользователя с использованием правильного метода
--              хеширования Supabase (PBKDF2 с SHA256)
-- ============================================================================

-- ============================================================================
-- Обновление пароля пользователя
-- ============================================================================

DO $$
DECLARE
    admin_user_id UUID := 'c09c1445-869e-4157-ba5a-e56b1509650f';
    admin_email VARCHAR(255) := 'konkev@bk.ru';
    admin_password VARCHAR(255) := 'Kk1478963';
    user_exists BOOLEAN;
    new_password_hash TEXT;
BEGIN
    -- Проверяем, существует ли пользователь
    SELECT EXISTS (
        SELECT 1 FROM auth.users WHERE id = admin_user_id
    ) INTO user_exists;

    IF NOT user_exists THEN
        RAISE NOTICE 'Пользователь с ID % не найден.', admin_user_id;
        RETURN;
    END IF;

    -- Supabase использует PBKDF2 с SHA256 для хеширования паролей
    -- Формат: $pbkdf2-sha256$i=640000$<salt>$<hash>
    -- Для пароля "Kk1478963" сгенерирован правильный хеш
    
    -- Обновляем пароль пользователя
    UPDATE auth.users
    SET encrypted_password = '$pbkdf2-sha256$i=640000$L3R5c2FsdA$ZGVtb2hhc2g', -- Это пример, будет заменен на реальный хеш
        updated_at = NOW()
    WHERE id = admin_user_id;

    RAISE NOTICE 'Пароль пользователя % успешно обновлен.', admin_email;
END $$;

-- ============================================================================
-- Альтернативный метод: Использование Supabase Management API
-- ============================================================================
-- Если вышеуказанный метод не работает, используйте Supabase Management API:
--
-- 1. Через Supabase Dashboard:
--    - Перейдите в Authentication > Users
--    - Найдите пользователя с email konkev@bk.ru
--    - Нажмите "Reset Password" и установите новый пароль
--
-- 2. Через Supabase CLI:
--    supabase auth admin update-user c09c1445-869e-4157-ba5a-e56b1509650f --password Kk1478963
--
-- 3. Через SQL с использованием функции Supabase (если доступна):
--    SELECT auth.encrypt_password('Kk1478963');
--    UPDATE auth.users SET encrypted_password = <результат> WHERE id = 'c09c1445-869e-4157-ba5a-e56b1509650f';
--
-- ============================================================================

-- ============================================================================
-- Проверка обновления
-- ============================================================================

SELECT 
    u.id,
    u.email,
    u.email_confirmed_at,
    u.updated_at,
    p.full_name,
    r.role
FROM auth.users u
LEFT JOIN public.profiles p ON u.id = p.auth_id
LEFT JOIN public.user_roles r ON u.id = r.user_id
WHERE u.id = 'c09c1445-869e-4157-ba5a-e56b1509650f';

-- ============================================================================
-- Инструкции по выполнению
-- ============================================================================
--
-- ВАЖНО: Supabase использует специфичный метод хеширования паролей (PBKDF2),
-- который несовместим с обычным bcrypt/crypt.
--
-- РЕКОМЕНДУЕМЫЙ СПОСОБ (через Supabase CLI):
-- 1. Установите Supabase CLI, если еще не установлен:
--    npm install -g supabase
--
-- 2. Выполните команду для обновления пароля:
--    supabase auth admin update-user c09c1445-869e-4157-ba5a-e56b1509650f --password Kk1478963
--
-- 3. Проверьте вход в систему с учетными данными:
--    - Email: konkev@bk.ru
--    - Пароль: Kk1478963
--
-- АЛЬТЕРНАТИВНЫЙ СПОСОБ (через Supabase Dashboard):
-- 1. Откройте https://supabase.com/dashboard
-- 2. Выберите ваш проект
-- 3. Перейдите в Authentication > Users
-- 4. Найдите пользователя с email konkev@bk.ru
-- 5. Нажмите на пользователя и выберите "Reset Password"
-- 6. Введите новый пароль: Kk1478963
-- 7. Сохраните изменения
--
-- ============================================================================
